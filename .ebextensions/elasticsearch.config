Resources:
  SaleorElasticsearch:
    Type: AWS::Elasticsearch::Domain
    Properties:
      DomainName: saleores
      ElasticsearchVersion: 6.4
      ElasticsearchClusterConfig:
        InstanceType: t2.small.elasticsearch
        InstanceCount: 1
        # DedicatedMasterEnabled: false
        # ZoneAwarenessEnabled: false
      EBSOptions:
        EBSEnabled: true
        VolumeType: gp2
        VolumeSize: 10
      AccessPolicies:
        Version: "2012-10-17"
        Statement:
          - - Effect: "Allow"
            - Principal:
                AWS: "*"
            - Action: "es:*"
            - Resource: "*"

container_commands:
  01virtualenv:
    command:
      Fn::Join:
        - ''
        - - 'echo "export ELASTICSEARCH_URL='
          - Fn::GetAtt:
            - SaleorElasticsearch
            - DomainEndpoint
          - '" >> ../env'
  02index:
    command: "python manage.py search_index --rebuild -f"
    env:
      ELASTICSEARCH_URL:
        Fn::GetAtt:
          - SaleorElasticsearch
          - DomainEndpoint
